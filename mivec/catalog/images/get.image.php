<?php
/**
 * 根据SKU 得到产品图片按原来的目录结构保存
 */
require 'config.php';
ini_set('display_errors' , 1);

$skuStr = "
SAMG950F22,SAMG950F25,SAMG950F26,SAMG935F05,SAMG935F01,SAMG935F20,SAMG930F01,GH31-00728A,GH82-11429A,GH97-17819A,GH97-17819B,GH82-10336B,GH82-10336D,SAMG928F19,SAG92534,SAG92533,GH43-04420B,SAG92520,SAG92519,GH82-09548C,SAG92009,SAG92007,SAG92021,SAG92016,SAG92020,GH97-18249A,GH97-18249B,GH82-11093A,GH82-11093B,GH82-11093C,SAMA310F02,SAMA310F11,SAMA310F12,SAMA310F08,SAMA310F09,SAMA310F13,SAMA310F04,SAMA310F06,SAMA310F03,SAMA310F10,GH97-18224A,GH97-18224B,GH97-18224C,gh97-17667a,SAMJ500F02,SAMJ500F01,SAMJ500F03,SAMJ500F08,SAMJ500F09,SAMJ500F06,SAMJ500F04,SAMJ500F07,SAMJ500F05,SM410,SM308,SM310,SAMG900F04,SAMG900F05,SAMG900F06,SM418,GH97-16147D,GH97-16147B,GH97-16147A,4897058380637,SM220,8806085601840,4897058380637,SM185,SM186,SM427,SM183,SM200,SM199,SM352,SM201,TOL29,GH97-14106C,SM351,8806085293939,SM349,SM329,SAMA7001,SAMA7002,SAMA7003,GH97+16679B,GH97+16679A,SAMA5005,SAMA5001,4897058380590,SAMA5003,SAMA5004,GH97+16747A,SAMA3002,GH96-08064D,GH96-08064E,SAMJ100H07,SAMJ100H08,SAMJ100H06,SAMJ100H05,SM537,GH97-12712A,SM132,SM163,EJ-PN910BBEGWW,GH98-33618B,SM395,SAMN910F05,FM49,SM109,SM148,SM149,TOL31,SM380,GH96-07760A,GH96-07760B ,GH96-07803B,GH96-07803A,SAMG530F08,SAMG530F09,SAMG530F06,SAMG530F04,SAMG530F07,SAMG530F05,SAMG530F10,GH96-08740B,SAMG360F05,SAMG360F06,SAMG360F04,SAMG360F03,SAMG360F07,SM241,GH96-08338A,GH98-36285A,SM420,SM245,SM244,SM194,SM160,SM251,GH97-16386C,GH97-16386B,GH97-16386A,GH97-16386E,SM114,GH97-15986A,SM61,SM54,GH96-08622A,SAMJ310F01,SAMJ510F04,SM80,SM58,GH97-14204A,BA129,SM415,SM164,SM66,SM172,SM236,SM15,SM04,SM123,SM122,FM14,SM540,SM06,SM92,SM239,SM227,SM226,SM44,GH96-03746A,GH07-01258A,SM409,SM507,SM545,SM516,SM402,SM416,GH43-03508A,SM119,SM166,SM422,SM315,SM301,SM407,SM401,SM408,SAMT55501,SAMT55502,GH96-08538A,SM120,7P21,7P22,7G25,7G26,5S23,5S20,CO5G09,5G15,5G14,5G79,5G80,5G81,IPAP52,IPAP53,IPAP51,IPAP50,IPAP06,IPAP03,IPAP05,GSP009,GSP010,BA77,AP48,AP47,AP48,AP47,IPAF38,IPAM404,AP129,AP124,AP204,AP205,AP58,AP134,4897058380064,4897058382914,4897058382921,4897058382747,4897058382938,4897058382945,4897058382723,4897058382730,4897058382754,4897058380163,4897058381092,4897058382839,4897058382846,4897058382853,4897058382860,4897058381030,4897058381047,4897058382907,4897058382877,4897058382884,4897058382891,4897058381023,4897058380941,4897058380934,TBH2009,TBH2007,TBH2008,4897058380958,4897058380965,4897058380972,4897058382808,TBH2005,TBH2006,4897058380828,4897058380996,4897058380811,4897058380835,4897058380989,4897058381016,4897058381009,4897058380897,4897058380880,4897058380873,4897058380866,4897058380903,4897058380910,4897058380927,4897058382822,4897058380408,4897058383911,4897058383928,tab30pin,4897058383690,4897058383669,4897058383676,4897058383683,4897058385304,4897058383751,4897058385342,4897058383195,4897058383164,4897058383812,4897058383829,4897058383775,4897058383799,4897058383805,4897058383768,4897058383836,4897058383843,4897058382334,4897058382419,4897058382402,T602020,7394090900184,7394090900207,7394090900177,6955250265904,6955250265867,6955250265805,6955250267281,KA42,4897058380132,AP05-PKP,6955250255837,6955250255851,6955250255844,KA112,5017416492607,6955250263764,LBC12,6955250263948,6955250263986,9788087049099,TBH515,8806085601840,8806085293939,8806085293922,TBH44,6955250257671,TBH81,6955250258432,6955250257695,EJ-PN910BBEGWW,GH98-33618B,TBH253,SM319,SM320,4897058383553,4897058383560,4897058383577,4897058383584,4897058383522,6958944601453,6958944600081G,6954284020305,6954284047418-2,6954284047418-3,6954284047418-4,6954284047418,6954284020305-2,6954284020305-3,6954284020305-4,5705260039559,BMH1350EFEGXEG,DAT05,DAT14,DAT45,DAT20,DAT40,DAT06,DAT42,DAT50,DAT16,DAT73,DAT51,DAT52,DAT53,DAT54,DAT55,DAT56,DAT57,DAT58,DAT59,DAT60,DAT61,4047038644079,ACER01,Ac-Adapter,AC-Adapter4,AC-Adapter5,AC Adapter 6,AC Adapter 7,AC Adapter 8,AC Adapter 9,HP04,HP02,AP01,5350551999953,TOOL1058,TOOL1062,7340004668589,TOOL1059,TOOL1060,TOOL1061,TOL22,TOOL1014,TOOL1056,TOOL1055,TOOL1003,TOOL1002,TOOL1054,TOOL1001,TOOL1005,TOOL1004,GH68-09361A,TOL02,TOL03,TOL07,740617182972";
$skuArr = strToArray($skuStr);
$_file = 'report.img.csv';
$header = "SKU,img";
$fp = fopen(__DATA_PATH__."/$_file" , 'wb');
fputcsv($fp , strToArray($header));

if ($skuArr = strToArray($skuStr)) {
	//$skuArr = array('GH82-11429A');
	foreach ($skuArr as $_key => $_sku) {
		if ($_id = getProductBySku($_sku)) {
			if ($_imgRows = getImages($_id)) {
				$_destin = "";
				foreach ($_imgRows as $_img) {
					$_destinDir = setImageDir($_img['url']);
					$_source = $_mediaDir . $_img['url'];
					$_destin = $_destinDir . "/" . getImageParam($_img['url']);
					try {
/*						if (copy($_source,$_destin)) {
							echo "SKU $_destin was successfully to copy</p>";
							usleep(5);
							//exit;
						}*/
					} catch (exception $e) {
						echo $e->getCode() . " " . $e->getMessage();
					}
					//write to csv
					fputcsv($fp , array("`" . $_sku , $_img['url']));
				}
			}
		}
		//if ($_key == 10) break;
	}
}


function getProductBySku($_sku)
{
	global $db;
	$sql = "SELECT entity_id FROM " . __TABLE_PRODUCT__." WHERE `sku`='$_sku'";
	return $db->fetchOne($sql);
}

function setImageDir($_img)
{
	$_dir = __DATA_PATH__ . getImageParam($_img , 'dir');
	if (multiDir($_dir)) {
		return $_dir;
	}
	return $_dir;
}
fclose($fp);